#!/usr/bin/python3.5
from sysflow.reader import FlattenedSFReader
import sys
import sysflow.utils as utils
from sysflow.objtypes import ObjectTypes

reader = FlattenedSFReader(sys.argv[1], False)



print("|{0:50}|{1:5}|{2:5}|{3:9}|{4:26}|{5:26}|{6:5}|{7:45}|{8:8}|{9:8}|{10:45}|{11:10}|".format("Process","PID","TID","Op Flags", "Start Time", "End Time", "Ret", "Resource 1", "NBRead", "NBWrite", "Resource 2", "Cont")) 



for objtype, header, cont, proc, files, evt, flow  in reader:
    exe = proc.exe + ' ' + proc.exeArgs if proc is not None else ''
    pid = proc.oid.hpid if proc is not None else ''
    #evflow = evt if evt is not None else flow
    evflow = evt or flow
    tid = evflow.tid if evflow is not None else ''
    opFlags = utils.getOpFlagsStr(evflow.opFlags) if evflow is not None else '' 
    sTime = utils.getTimeStr(evflow.ts) if evflow is not None else ''
    eTime = utils.getTimeStr(evflow.endTs) if flow is not None else ''
    ret = evflow.ret if evt is not None else ''
    res1 = ''
    if objtype == ObjectTypes.FILE_FLOW or objtype == ObjectTypes.FILE_EVT:
        res1 = files[0].path
    elif objtype == ObjectTypes.NET_FLOW:
        res1 = utils.getNetFlowStr(flow) 
    numBReads = evflow.numRRecvBytes if flow is not None else ''
    numBWrites = evflow.numWSendBytes if flow is not None else ''
    
    res2 = files[1].path if files is not None and files[1] is not None else ''
    cont = cont.id if cont is not None else '' 
    #print(f'|{exe:50}|{pid:5}|{tid:5}|{opFlags:8}|{sTime:23}|{eTime:23}|{ret:5}|{res1:45}|{numBReads:8}|{numBWrites:8}|{res2:45}|{cont:10}|')
    print("|{0:50}|{1:5}|{2:5}|{3:9}|{4:26}|{5:26}|{6:5}|{7:45}|{8:8}|{9:8}|{10:45}|{11:10}|".format(exe, pid, tid, opFlags, sTime, eTime, ret, res1, numBReads, numBWrites, res2, cont))
